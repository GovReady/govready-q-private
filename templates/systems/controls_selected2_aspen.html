{% extends "summary-base.html" %}
{% load humanize %}
{% load guardian_tags %}
{% load static %}
{% load q %}
{% load system_tags %}

{% block title %}
System
{% endblock %}

{% block head %}
{{block.super}}
{% include "controls/_style-controls.html" %}
{% endblock %}

<!-- action buttons included from project-base.html -->
<!-- authoring_tool_enabled included from project-base.html -->

{% block body_content %}

<style>
</style>

<div style="margin-top:8px; padding:20px 50px 0 50px; border-top:1px solid #ccc; background-color:#F5F5F5;">
<div class="row">
      <div class="col-md-8" style="">
          <h3 class="system-classification">{{ system_summary.impact }}</h3>
          <h2 class="system-name">{{ system_summary.name }}</h2>
          <h3 class="system-aka"><span style="font-size:.8em;">A.K.A.</span> {% for aka in system_summary.aka %}"{{ aka }}"{% if not forloop.last %}, {% endif %}{% endfor %}"</h3>
      </div>

    <div class="col-md-4"><h5 class="sys-wide-status-header">Organization-wide Initiative Status</h5>
        <div style="border:1px solid #CCCCCC; padding:8px;">
            <table id="sys-wide-status">
                <tr><td style="width:15px;"><div class="status-box status-red">&nbsp;</div></td><td class="sys-wide-status">800-53 rev5 migration</td></tr>
                <tr><td><div class="status-box status-yellow">&nbsp;</div></td><td class="sys-wide-status">Log4J remediation solution (updated 4/21/22)</td></tr>
                <tr><td><div class="status-box status-green">&nbsp;</div></td><td class="sys-wide-status">Q3 Audit</td></tr>
            </table>
        </div>
    </div>
</div>

{% include "summary-horizontal-nav.html" %}
</div>
<div style="padding:0 50px 0 50px;">
<div class="row">
<!-- start left sidebar -->
<!-- <div class="col-sm-3">
{% include "summary-sidebar.html" %}
</div> --> <!-- ends left sidebar -->

<div class="col-sm-12"><!-- starts content area -->

  <div class="row" style="padding:50px 0 0 20px; ">
    <div class="col-md-12"><h4 class="sys-summary-header">Controls Overview</h4></div>

    <div style="max-width:100%; padding-left:1em;">
      <p class="sys-summary-content">
        Controls are the selected cybersecurity compliance goals required for your system installed and operating in your organization.
      </p>

      <div class="" style="">
        {% if controls|length < 1 %}
          <p>No controls are currently selected for your system.</p>
        {% else %}
          <div class="row">
            {% for family in families %}
              <div id="" class="col-xs-3 col-sm-3 col-md-3 col-lg-3 col-xl-3">
                <div class style="border:0.5px solid #888;min-height:300px;width:100%;margin-bottom:20px;padding:8px;">
                  <h2 style="min-height: 2em;">{{ family.family_title|title }} ({{family.family_id|upper}})</h2>
                  <div>{{family.control_total}} controls</div>
                  {% for control in controls %}
                    {% if control.get_flattened_oscal_control_as_dict.family_id == family.family_id %}
                     <div class="small" style="display:inline;background-color: #fee;margin-right: 4px;">
                      <a href="{% url 'control_editor' system_id=system.id catalog_key=control.oscal_catalog_key cl_id=control.oscal_ctl_id %}" style="color:black;">{{ control.get_flattened_oscal_control_as_dict.id_display|upper }}</a>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

    </div>

  </div>


  </div>






</div> <!-- ends main md content well -->
</div> <!-- ends row -->





{% endblock %}

{% block scripts %}
    {{ block.super }}
<script>
    window.system_summary({{system.id}}, {{project.id}});
</script>
<script>
  function show_control_by_id() {
    var control_id = $('#control-lookup').find('input[name="id"]').val();
    var url = "/systems/{{ system.id }}/controls/catalogs/{{ control_id.oscal_catalog_key }}/control/" + control_id;
    window.location.href = url;
  }

  $(document).ready(function() {
    // Download button shows a modal to ask what file format to download in.
    function download_document(document_id, system_id) {
      var dom = $("<div><p>Select download format:</p>"
        + "<select class=form-control>"
        {% if enable_experimental_opencontrol %}
        + "<option value='opencontrol'>OpenControl Repository</option>"
        {% endif %}
        + "<option value='xacta'>Xacta Import Spreadsheet</option>"
        + "</select>"
        + "</div>");
      show_modal_confirm("Download Document", dom, "Download", function() {
        var format = dom.find("select").val();
        switch(format) {
          case "opencontrol":
            window.location = "/systems/" + system_id + "/components/selected/export/opencontrol";
            break;
          case "xacta":
            window.location = "selected/export/" + format + "/xlsx";
            break;
        }
      });
    }

    // Add:  Convert form select to jQuery Select2
    $('#add-control_id-select').select2({
      ajax: {
              url: "/controls/api/controlsselect/",
              dataType: 'json',
              delay: 250,
              data: function(params) {
                  return {
                      q: params.term // search term
                  };
              },
              processResults: function(data, params) {
                  var resData = [];
                  data.data.controls.forEach(function(value) {
                      if (value.display_text.indexOf(params.term) != -1)
                          resData.push(value)
                  })
                  return {
                      results: $.map(resData, function(item) {
                          return {
                              text: item.display_text,
                              id: item.id
                          }
                      })
                  };
              },
              cache: true
          },
          minimumInputLength: 1
    }).on('select2:select', function (e) {
      // After change event for which e.params isn't defined
      // Split the control string to get oscal_control_id and get catalog_key (e.g., catalog identifier)
      display_text = e.params.data.text;
      displaytext = display_text.split(' - ');
      var first = displaytext.shift(); //or arr[arr.length-1];
      var last = displaytext.pop(); //or arr[0];
      dtv = [first, displaytext.join(" - "), last]; // [control_id, title, catalog_key]
      ck = dtv[1];
      // $('#add-catalog_key-input').val(e.params.data.catalog_key);
      $('#add-catalog_key-input').val(ck.replace(" ","_"));
      $('#add-control').submit();
    });

  }); //$(document).ready(function()

  // Confirm deletion of control
  function confirm_cnt_rm(cnt_rm_url) {
    var result = confirm('Remove selected control from system?\nAny customizations to control\'s statements will be lost.');
      if (result) {
        window.location.href = cnt_rm_url;
      }
    }
</script>

{% endblock %}
